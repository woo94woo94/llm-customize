# 프로젝트 관리 시스템 질의응답 - API 기반 분석

**작성일**: 2024-11-06  
**분석 기준**: api.yaml, domain.md, coq_answer_from_domain_simple.md  
**작성 방식**: REST API 호출 + LLM 데이터 조합 + 비즈니스 로직

---

## ✅ 질문별 달성가능성 평가

| 번호 | 질문 요약 | API 가능 | 신뢰도 | 복잡도 | 비고 |
|------|----------|----------|--------|--------|------|
| 1 | 당월 전망 매출/직접이익 (실 단위) | ✅ | 95% | 중 | 다단계 조회 필요 |
| 2 | M+3 월별 매출 전망 (Rolling + 수주가능성) | ✅ | 90% | 높음 | 두 데이터 소스 조합 |
| 3 | 최근 2개년 매출실적 PBS 집계 | ✅ | 100% | 중 | 직관적 집계 |
| 4 | 영업이익 적자 수주 프로젝트 | ✅ | 100% | 낮음 | 단순 필터링 |
| 5 | 최근 3개월 실매출가동율 | ✅ | 100% | 중 | 타임카드 집계 필요 |
| 6 | 직접이익율 5% 변동 프로젝트 | ✅ | 95% | 높음 | 최초/최종 비교 |
| 7 | 전망 vs 실적 gap 분석 | ✅ | 90% | 중 | 시점 매칭 필요 |
| 8 | 최초계약이익율 분석/그래프 | ✅ | 100% | 중 | 통계 + 시각화 |

**복잡도 기준**:
- **낮음**: API 1~2개, 단순 필터링
- **중**: API 3~5개, 데이터 조합 필요
- **높음**: API 5개 이상, 복잡한 비즈니스 로직

**신뢰도 기준**:
- **100%**: 모든 필요 데이터가 API로 직접 제공됨
- **95%**: 일부 데이터는 계산 또는 추론 필요
- **90%**: 복잡한 조합 로직 또는 데이터 가정 필요

---

## 📌 시스템 구조

**데이터 조회 방식**:
1. REST API를 통해 필요한 데이터 조회
2. 여러 API 응답을 LLM이 조합 및 가공
3. 비즈니스 로직 적용하여 최종 결과 생성

**주요 특징**:
- 코드 없이 자연어로 비즈니스 로직 설명
- API 엔드포인트와 파라미터 명시
- 데이터 조합 순서 및 방법 제시

---

## 질문별 상세 분석

### 질문 1: 당월 전망 매출/직접이익 (실 단위)

#### 📡 필요 API 호출

**1단계: 월별 계획 데이터 조회**
- **API**: `GET /api/monthly-plans`
- **필터 파라미터**:
  - `plan_ver`: 최신 버전 (먼저 프로젝트별 최신 버전 확인 필요)
  - `start_year`: 당월이 속한 년도
  - 페이징: 전체 조회 필요

**2단계: 프로젝트 정보 조회**
- **API**: `GET /api/projects`
- **필터 파라미터**: 없음 (1단계에서 조회된 pjt_cd 목록 기준)

**3단계: WBS 정보 조회**
- **API**: 각 프로젝트별 `GET /api/projects/{pjt_cd}/wbs`
- **목적**: dept_cd(부서 코드) 확보

**4단계: 부서 정보 조회**
- **API**: `GET /api/departments`
- **필터 파라미터**:
  - `dept_dtt_cd`: 부서 구분이 '실'인 부서만
  - `use_yn`: Y

**5단계: 공통코드 조회 (계정구분)**
- **API**: `GET /api/common-codes/PM039`
- **목적**: acct_dtt 코드값 확인 (매출, 노무비, 재료비, 협력작업비, 경비)

#### 🔄 데이터 조합 로직

1. 월별 계획 데이터(po_plan_mth_mgt)에서 당월에 해당하는 컬럼 선택
   - start_year와 당월을 비교하여 m1~m24 중 해당 컬럼 결정
   - 예: start_year가 2024이고 당월이 2024년 11월이면 → m11 컬럼

2. WBS의 dept_cd와 부서 정보를 매칭하여 '실' 단위 필터링

3. 계정구분별로 금액 분류:
   - 매출: acct_dtt가 매출에 해당하는 코드
   - 직접원가: 노무비 + 재료비 + 협력작업비 + 경비

4. 실 단위별 집계:
   - 각 실별로 매출 합계
   - 각 실별로 직접원가 합계
   - 직접이익 = 매출 - 직접원가

#### 💡 비즈니스 로직 (자연어)

당월 전망 매출과 직접이익을 조회하기 위해서는 먼저 수주영업 월별 계획 데이터에서 최신 계획 버전을 기준으로 데이터를 가져옵니다. 각 프로젝트와 WBS의 계획 데이터는 시작 년도와 이십사 개월치 금액 컬럼으로 구성되어 있으므로, 현재 월이 시작 년도로부터 몇 번째 월인지 계산하여 해당하는 월 컬럼의 값을 추출합니다.

WBS는 부서 코드를 가지고 있으며, 이 부서 코드를 통해 부서 정보와 연결합니다. 부서는 여러 구분(본부, 실, 팀 등)으로 나뉘는데, 이 중 부서 구분이 '실'인 조직만 필터링합니다.

각 WBS와 프로젝트의 계획 데이터는 계정 구분 필드를 통해 매출, 노무비, 재료비, 협력작업비, 경비 등으로 분류됩니다. PM039 공통코드를 조회하여 각 계정 구분 코드가 어떤 원가 항목을 의미하는지 파악합니다.

실 단위로 그룹핑하여 다음을 계산합니다:
- 전망 매출: 해당 실에 속한 모든 WBS의 매출 계정 금액 합계
- 직접원가: 노무비, 재료비, 협력작업비, 경비 계정 금액의 합계
- 직접이익: 전망 매출에서 직접원가를 차감

최종적으로 실별로 당월 전망 매출과 직접이익을 산출합니다.

---

### 질문 2: M+3 월별 매출 전망 (Rolling + 수주가능성)

#### 📡 필요 API 호출

**[A] 실행 중 프로젝트 - Rolling Data**

**1단계: 프로젝트 목록 조회**
- **API**: `GET /api/projects`
- **필터 파라미터**:
  - `system_sts_cd`: 실행 상태 코드 (PM003 공통코드 중 '03:실행')

**2단계: 실행계획 버전 조회**
- **API**: `GET /api/execution-plans/versions`
- **필터 파라미터**:
  - `pjt_cd`: 1단계에서 조회된 프로젝트 코드
  - `approval_sts_cd`: 승인 상태 (CM080 공통코드 중 승인 코드)
  - 각 프로젝트별 최신 ver 선택 필요

**3단계: 실행손익 조회**
- **API**: `GET /api/profit-loss/execution-plan`
- **필터 파라미터**:
  - `pjt_cd`: 각 프로젝트 코드
  - `ver`: 2단계에서 확인한 최신 버전
  - `plan_ym`: M+1, M+2, M+3 월 (YYYYMM 형식)
  - `cst_ele_cd`: 매출 코드 (10으로 추정, 공통코드 확인 필요)

**[B] 신규 프로젝트 - 수주전망 Data**

**1단계: 영업/계약 단계 프로젝트 조회**
- **API**: `GET /api/projects`
- **필터 파라미터**:
  - `system_sts_cd`: 영업 또는 계약 상태 (PM003 공통코드 중 '01:영업', '02:계약')

**2단계: 수주전망 데이터 조회**
- **API**: `GET /api/monthly-plans`
- **필터 파라미터**:
  - `pjt_cd`: 1단계에서 조회된 프로젝트 코드
  - `plan_ver`: 최신 버전
  - `acct_dtt`: 매출 계정 코드 (PM039 공통코드)

**3단계: 공통코드 조회**
- **API**: `GET /api/common-codes/PM003` (프로젝트 상태)
- **API**: `GET /api/common-codes/PO002` (영업진행상태)

#### 🔄 데이터 조합 로직

**Rolling Data 처리**:
1. 실행 중인 프로젝트 목록을 확보
2. 각 프로젝트의 승인된 최신 실행계획 버전 확인
3. 실행손익 데이터에서 M+1, M+2, M+3 월의 매출 계획 추출
4. 월별, 프로젝트별로 매출액 집계

**수주전망 Data 처리**:
1. 영업 또는 계약 단계 프로젝트 목록 확보
2. 각 프로젝트의 수주가능성 지표 확인 (biz_chk, suju_score)
3. 월별 계획 데이터에서 M+1, M+2, M+3 해당 컬럼 추출
4. 수주가능성에 따라 분류:
   - 확실: biz_chk가 Y이고 suju_score가 18 이상
   - 가능: biz_chk가 Y이고 suju_score가 10 이상 18 미만
   - 유동: 그 외

**최종 조합**:
- M+1, M+2, M+3 각 월별로 Rolling 매출과 수주가능성별 신규 매출을 합산

#### 💡 비즈니스 로직 (자연어)

향후 삼 개월 매출 전망은 두 가지 데이터 소스로 구성됩니다.

첫째, 이미 실행 중인 프로젝트의 Rolling 매출입니다. 프로젝트 상태가 실행인 프로젝트들을 조회하고, 각 프로젝트의 승인된 최신 실행계획 버전을 확인합니다. 실행계획에는 월별 손익 데이터가 포함되어 있으며, 이 중 매출 원가요소에 해당하는 데이터를 추출합니다. 현재 월 기준으로 앞으로 일, 이, 삼 개월 후의 계획 매출액을 가져옵니다.

둘째, 아직 수주하지 못한 영업 단계 또는 계약 단계 프로젝트의 전망 매출입니다. 이들 프로젝트는 수주영업 월별 계획 테이블에서 관리되며, 최신 계획 버전의 데이터를 사용합니다. 각 프로젝트는 수주 가능성을 나타내는 지표를 가지고 있습니다. 검토 체크 여부와 수주 점수를 기준으로 수주 가능성을 세 단계로 분류합니다:
- 확실: 검토가 완료되었고 수주 점수가 십팔점 이상
- 가능: 검토가 완료되었고 수주 점수가 십점 이상
- 유동: 그 외의 경우

월별 계획 데이터는 시작 년도부터 이십사 개월치 금액을 컬럼으로 가지고 있으므로, M+1, M+2, M+3에 해당하는 컬럼을 계산하여 추출합니다.

최종적으로 각 월별로 실행 중 프로젝트의 Rolling 매출과 신규 프로젝트의 수주가능성별 전망 매출을 구분하여 제시합니다.

---

### 질문 3: 최근 2개년 매출실적 PBS 집계

#### 📡 필요 API 호출

**1단계: 매출실적 조회**
- **API**: `GET /api/revenue-actuals`
- **필터 파라미터**:
  - `rsl_ym`: 2023년 1월부터 2024년 12월까지 (202301 ~ 202412 범위)
  - 페이징: 전체 조회 필요

**2단계: 프로젝트 정보 조회**
- **API**: `GET /api/projects`
- **필터 파라미터**: 1단계에서 조회된 pjt_cd 목록 기준
- **목적**: PBS 코드 확보 (pbs_big_type_cd, pbs_middle_type_cd, pbs_small_type_cd)

**3단계: WBS 정보 조회**
- **API**: 각 프로젝트별 `GET /api/projects/{pjt_cd}/wbs`
- **목적**: dept_cd 확보

**4단계: 부서 정보 조회**
- **API**: `GET /api/departments`
- **필터 파라미터**:
  - `dept_nm`: 'IT사업실' (부분일치 검색) 또는 특정 실 명칭
  - `use_yn`: Y

**5단계: 공통코드 조회 (PBS 코드)**
- **API**: PBS 관련 공통코드 조회 (PBS 대/중/소 분류 코드명 확인)

#### 🔄 데이터 조합 로직

1. 매출실적 데이터에서 이천이십삼년과 이천이십사년 데이터 필터링
2. 각 실적의 프로젝트 코드로 프로젝트 정보 조회하여 PBS 코드 확보
3. WBS 정보를 통해 부서 코드 확인, IT사업실 소속 여부 판단
4. 실적 년월에서 년도 추출 (앞 네 자리)
5. PBS 대/중/소 분류별, 년도별로 매출액 집계

#### 💡 비즈니스 로직 (자연어)

최근 이 개년 매출실적을 PBS 기준으로 집계하기 위해서는 먼저 월별 매출실적 데이터를 조회합니다. 실적 년월 필드를 기준으로 이천이십삼년 일월부터 이천이십사년 십이월까지의 데이터를 필터링합니다.

각 매출실적은 프로젝트 코드와 WBS 코드를 포함하고 있습니다. 프로젝트 정보를 조회하여 해당 프로젝트의 PBS 코드를 확보합니다. PBS는 프로젝트의 사업 분류 체계로, 대분류, 중분류, 소분류로 구성됩니다.

WBS 정보를 통해 부서 코드를 확인하고, 부서 정보와 매칭하여 IT사업실 또는 특정 사업실 소속 여부를 판단합니다. 요청에 따라 특정 실로 필터링할 수 있습니다.

실적 년월의 앞 네 자리를 추출하여 년도를 구분합니다. 이천이십삼년과 이천이십사년 두 개 년도로 분류됩니다.

최종적으로 년도별, PBS 대분류별, PBS 중분류별, PBS 소분류별로 매출액을 집계합니다. 공통코드를 참조하여 PBS 코드값을 의미 있는 코드명으로 변환하여 제시합니다.

---

### 질문 4: 영업이익 적자 수주 프로젝트

#### 📡 필요 API 호출

**1단계: 최초계약 손익 조회**
- **API**: `GET /api/profit-loss/first-contract`
- **필터 파라미터**: 없음 (전체 조회 후 필터링)

**2단계: 프로젝트 정보 조회**
- **API**: `GET /api/projects`
- **필터 파라미터**:
  - `order_de`: 당해년도 범위 (예: from_date: 20240101, to_date: 20241231)

**3단계: 공통코드 조회**
- **API**: `GET /api/common-codes/PO011` (프로젝트 타입)

#### 🔄 데이터 조합 로직

1. 프로젝트 목록에서 당해년도 수주 프로젝트 필터링 (order_de 기준)
2. 각 프로젝트의 최초계약 손익 데이터 조회
3. po_f_biz_prof(최초 사업이익) 필드가 영보다 작은 프로젝트 필터링
4. 영업이익율 계산: (po_f_biz_prof / po_f_rev_amt) × 100
5. 적자 금액 및 이익율 기준으로 정렬

#### 💡 비즈니스 로직 (자연어)

영업이익 적자로 수주된 프로젝트를 찾기 위해서는 먼저 당해년도에 수주된 프로젝트 목록을 조회합니다. 수주일자 필드를 기준으로 현재 년도 일월 일일부터 십이월 삼십일일까지의 범위로 필터링합니다.

각 프로젝트의 최초계약 손익 정보를 조회합니다. 최초계약 손익은 프로젝트가 처음 계약을 체결할 때의 견적 기준 손익을 나타냅니다. 최초 사업이익 필드는 최초 매출액에서 직접원가와 공통비를 차감한 값으로, 영업이익에 해당합니다.

최초 사업이익이 영보다 작은 경우, 즉 적자인 프로젝트를 필터링합니다. 각 프로젝트의 영업이익율은 최초 사업이익을 최초 매출액으로 나눈 후 백을 곱하여 백분율로 계산합니다.

적자 프로젝트 목록을 작성할 때는 다음 정보를 포함합니다:
- 프로젝트 코드 및 명칭
- 수주일자
- 최초 매출액
- 최초 사업이익 (적자 금액)
- 영업이익율

적자 금액이 큰 순서대로 정렬하여 제시하면 경영진이 우선적으로 관리해야 할 프로젝트를 파악할 수 있습니다.

---

### 질문 5: 최근 3개월 실매출가동율

#### 📡 필요 API 호출

**1단계: 타임카드 데이터 조회**
- **API**: `POST /api/timecards/project/search`
- **POST body 파라미터**:
  - `timecard_ym_from`: 최근 삼 개월 시작 월 (예: 202408)
  - `timecard_ym_to`: 당월 (예: 202410)

**2단계: 프로젝트 정보 조회**
- **API**: `GET /api/projects`
- **필터 파라미터**: 1단계에서 조회된 pjt_cd 목록
- **목적**: pjt_type_id 확인 (비매출/비가동 프로젝트 제외)

**3단계: 직원 정보 조회**
- **API**: `GET /api/employees`
- **필터 파라미터**: 1단계에서 조회된 empno 목록
- **목적**: dept_cd 확인

**4단계: 부서 정보 조회**
- **API**: `GET /api/departments`
- **필터 파라미터**:
  - `dept_dtt_cd`: 부서 구분이 '실'
  - `use_yn`: Y

**5단계: 월별 기준 근무시간 조회**
- **API**: `GET /api/work-times`
- **필터 파라미터**:
  - `work_yy`: 최근 삼 개월이 속한 년도
  - `work_mm`: 각 월
  - `use_yn`: Y

**6단계: 공통코드 조회**
- **API**: `GET /api/common-codes/PO011` (프로젝트 타입)
- **목적**: 비매출, 비가동 프로젝트 타입 코드 확인

#### 🔄 데이터 조합 로직

1. 최근 삼 개월의 타임카드 데이터 조회
2. 프로젝트 타입이 비매출 또는 비가동인 프로젝트 제외
3. 직원의 부서 코드를 통해 '실' 단위 부서 소속 직원만 필터링
4. 각 타임카드의 일별 근무시간 합산 (work_date_1 ~ work_date_31)
5. 월별, 실별로 투입시간 집계
6. 월별 기준 근무시간과 인원수를 곱하여 기준 근무시간 계산
7. 실매출가동율 = (투입시간 / 기준근무시간) × 100

#### 💡 비즈니스 로직 (자연어)

실매출가동율은 조직 인력이 실제 매출을 발생시키는 프로젝트에 얼마나 투입되었는지를 나타내는 지표입니다. 최근 삼 개월간의 실매출가동율을 조회하기 위해 먼저 해당 기간의 타임카드 데이터를 조회합니다.

타임카드는 직원이 일별로 프로젝트에 투입한 시간을 기록한 데이터입니다. 각 타임카드는 프로젝트 코드, WBS 코드, 사원번호, 실적 년월, 그리고 일별 근무시간 필드(일일부터 삼십일일까지)를 포함합니다.

프로젝트 정보를 조회하여 프로젝트 타입을 확인합니다. 프로젝트 타입이 비매출이거나 비가동인 경우는 매출을 발생시키지 않는 프로젝트이므로 제외합니다. 공통코드를 통해 비매출 및 비가동 프로젝트 타입 코드를 확인할 수 있습니다.

직원 정보를 조회하여 각 직원의 소속 부서를 확인합니다. 부서 정보와 매칭하여 부서 구분이 '실'인 조직 소속 직원만 포함합니다. 이는 실 단위로 가동율을 집계하기 위함입니다.

각 타임카드의 일별 근무시간을 모두 합산하여 월별 투입시간을 계산합니다. 실별, 월별로 모든 직원의 투입시간을 합산합니다.

월별 기준 근무시간은 월 근무시간 테이블에서 조회합니다. 사용 여부가 Y인 최신 기준을 사용하며, 일반적으로 월 백육십팔시간이 기준입니다. 기준 근무시간에 해당 실의 인원수를 곱하여 총 기준 근무시간을 계산합니다.

실매출가동율은 실제 투입시간을 기준 근무시간으로 나눈 후 백을 곱하여 백분율로 표현합니다. 이 값이 백 퍼센트에 가까울수록 조직 인력이 매출 프로젝트에 충분히 투입되고 있음을 의미합니다.

최근 삼 개월의 월별 실매출가동율을 실 단위로 제시하여 조직별 인력 활용도를 파악할 수 있습니다.

---

### 질문 6: 직접이익율 5% 변동 프로젝트

#### 📡 필요 API 호출

**1단계: 실행 중 프로젝트 조회**
- **API**: `GET /api/projects`
- **필터 파라미터**:
  - `system_sts_cd`: 실행 상태 (PM003 공통코드 중 '03:실행')

**2단계: WBS 정보 조회**
- **API**: 각 프로젝트별 `GET /api/projects/{pjt_cd}/wbs`

**3단계: 부서 정보 조회**
- **API**: `GET /api/departments`
- **필터 파라미터**:
  - `dept_dtt_cd`: 부서 구분이 '실'
  - `use_yn`: Y

**4단계: 최초계약 손익 조회**
- **API**: `GET /api/profit-loss/first-contract`
- **필터 파라미터**: 1단계의 pjt_cd 목록

**5단계: 실행계획 버전 조회**
- **API**: `GET /api/execution-plans/versions`
- **필터 파라미터**:
  - `pjt_cd`: 각 프로젝트 코드
  - `approval_sts_cd`: 승인 상태 (CM080 공통코드)
  - 각 프로젝트별 최신 ver 확인

**6단계: 최종 실행손익 조회 (Hold 포함)**
- **API**: `GET /api/profit-loss/execution-plan/with-hold`
- **필터 파라미터**:
  - `pjt_cd`: 각 프로젝트 코드
  - `ver`: 5단계에서 확인한 최신 버전

**7단계: 공통코드 조회**
- **API**: `GET /api/common-codes` (손익 원가요소 코드)
- **목적**: 매출, 노무비, 재료비, 협력작업비, 경비 코드값 확인

#### 🔄 데이터 조합 로직

1. 실행 중인 프로젝트 목록 확보
2. WBS와 부서 정보를 통해 '실' 단위 조직 소속 프로젝트 필터링
3. 최초계약 손익에서 최초 직접이익율 계산:
   - 최초 직접이익 = po_f_rev_amt - (po_f_lcost_amt + po_f_mcost_amt + po_f_ecost_amt)
   - 최초 직접이익율 = (최초 직접이익 / po_f_rev_amt) × 100

4. 실행손익 데이터에서 최종 직접이익율 계산:
   - 원가요소별로 매출, 노무비, 재료비, 협력작업비, 경비 금액 추출
   - 최종 직접이익 = 최종 매출 - (노무비 + 재료비 + 협력작업비 + 경비)
   - 최종 직접이익율 = (최종 직접이익 / 최종 매출) × 100

5. 이익율 차이 = 최종 직접이익율 - 최초 직접이익율
6. 절대값이 오 이상인 프로젝트 필터링

#### 💡 비즈니스 로직 (자연어)

직접이익율이 최초 계약 대비 오 퍼센트 이상 변동된 프로젝트를 찾기 위해서는 최초 계약 시점의 이익율과 최종 실행계획의 이익율을 비교해야 합니다.

먼저 현재 실행 중인 프로젝트 목록을 조회합니다. 프로젝트 상태가 실행인 프로젝트만 대상으로 합니다. WBS 정보와 부서 정보를 연결하여 특정 실 소속 프로젝트로 범위를 한정할 수 있습니다.

최초계약 손익 데이터에서 최초 직접이익을 계산합니다. 최초 매출액에서 최초 노무비, 최초 재료비, 최초 경비를 차감합니다. 협력작업비는 재료비에 포함될 수 있으며, 해당 필드가 별도로 있다면 함께 차감합니다. 최초 직접이익을 최초 매출액으로 나눈 후 백을 곱하여 최초 직접이익율을 산출합니다.

현재 시점의 최종 직접이익율을 계산하기 위해 최신 실행계획 손익 데이터를 조회합니다. 각 프로젝트의 승인된 최신 실행계획 버전을 확인하고, 해당 버전의 실행손익 데이터를 가져옵니다. 결재 중인 데이터도 포함하기 위해 Hold 데이터를 포함한 VIEW를 사용합니다.

실행손익 데이터는 원가요소 코드로 구분되어 있습니다. 매출 원가요소 코드에 해당하는 금액을 모두 합산하여 최종 매출을 계산합니다. 마찬가지로 노무비, 재료비, 협력작업비, 경비 원가요소 코드에 해당하는 금액을 합산하여 최종 직접원가를 계산합니다. 최종 직접이익은 최종 매출에서 최종 직접원가를 차감한 값이며, 이를 최종 매출로 나눈 후 백을 곱하여 최종 직접이익율을 산출합니다.

두 이익율의 차이를 계산합니다. 차이의 절대값이 오 이상인 프로젝트를 필터링합니다. 양수인 경우 이익율이 개선된 것이고, 음수인 경우 이익율이 악화된 것입니다.

결과는 다음 정보를 포함하여 제시합니다:
- 프로젝트 코드 및 명칭
- 소속 실
- 최초 직접이익율
- 최종 직접이익율
- 이익율 차이
- 변동 방향 (개선/악화)

이익율 차이의 절대값이 큰 순서대로 정렬하여 관리가 필요한 프로젝트를 우선적으로 파악할 수 있도록 합니다.

---

### 질문 7: 전망 vs 실적 gap 분석

#### 📡 필요 API 호출

**1단계: 전월 작성 전망 데이터 조회**
- **API**: `GET /api/monthly-plans`
- **필터 파라미터**:
  - `plan_ver`: 최신 버전
  - `acct_dtt`: 매출 계정 코드 (PM039 공통코드)
- **추가 필터**: 생성일시(fst_creat_dt)가 전월인 데이터 (API에서 지원하지 않으면 전체 조회 후 필터링)

**2단계: 당월 매출실적 조회**
- **API**: `GET /api/revenue-actuals`
- **필터 파라미터**:
  - `rsl_ym`: 당월 (예: 202411)

**3단계: 프로젝트 정보 조회**
- **API**: `GET /api/projects`
- **필터 파라미터**: 1, 2단계에서 조회된 pjt_cd 목록

**4단계: WBS 정보 조회**
- **API**: 각 프로젝트별 `GET /api/projects/{pjt_cd}/wbs`

**5단계: 공통코드 조회**
- **API**: `GET /api/common-codes/PM039` (계정구분)

#### 🔄 데이터 조합 로직

1. 전월에 작성된 월별 계획 데이터 필터링:
   - 생성일시가 전월 일일부터 말일까지
   - 최신 계획 버전
   - 계정구분이 매출

2. 해당 월별 계획의 당월(M+1) 컬럼 금액 추출:
   - start_year와 당월을 비교하여 해당 월 컬럼 결정

3. 당월 매출실적 데이터에서 프로젝트별 실적 합산

4. 프로젝트별 Gap 계산:
   - Gap = 당월 실적 - 전월 전망

5. Gap 절대값이 일억원 이상인 프로젝트 필터링

6. 전망 대비 실적 비율 계산: (실적 / 전망) × 100

#### 💡 비즈니스 로직 (자연어)

전망 대비 실적의 차이를 분석하기 위해서는 전월에 작성된 당월 전망과 실제 발생한 당월 실적을 비교합니다.

먼저 수주영업 월별 계획 데이터에서 전월에 작성된 계획을 조회합니다. 생성일시 필드를 기준으로 전월 일일부터 말일까지 생성된 레코드를 필터링합니다. 각 프로젝트의 최신 계획 버전을 선택하고, 계정구분이 매출에 해당하는 데이터만 추출합니다.

월별 계획 데이터는 시작 년도부터 이십사 개월치 금액을 컬럼으로 가지고 있습니다. 전월에 작성했으므로 당월은 M+1에 해당합니다. 시작 년도와 당월을 비교하여 해당하는 월 컬럼의 금액을 추출합니다. 이것이 전월에 예측한 당월 매출 전망입니다.

당월 매출실적 데이터를 조회합니다. 실적 년월이 당월인 모든 매출실적을 가져오며, 프로젝트별, WBS별로 합산하여 프로젝트 단위 실적을 계산합니다.

각 프로젝트별로 전망과 실적을 비교하여 Gap을 계산합니다. Gap은 실적에서 전망을 뺀 값으로, 양수이면 전망보다 실적이 높은 것이고, 음수이면 전망보다 실적이 낮은 것입니다.

Gap의 절대값이 일억원 이상인 프로젝트를 필터링합니다. 이는 전망과 실적의 차이가 유의미하게 큰 프로젝트를 찾기 위함입니다.

각 프로젝트에 대해 전망 대비 실적 비율을 계산합니다. 실적을 전망으로 나눈 후 백을 곱하여 백분율로 표현합니다. 백 퍼센트면 전망과 실적이 일치하는 것이고, 백 퍼센트보다 크면 초과 달성, 작으면 미달입니다.

결과는 다음 정보를 포함합니다:
- 프로젝트 코드 및 명칭
- 전월 작성 당월 전망
- 당월 실적
- Gap (실적 - 전망)
- 달성률 (실적 / 전망 × 100)

Gap이 큰 순서대로 정렬하여 전망 정확도가 낮은 프로젝트를 파악하고, 향후 전망 작성 시 개선할 수 있도록 합니다.

---

### 질문 8: 최초계약이익율 분석 (그래프)

#### 📡 필요 API 호출

**1단계: 최근 이 개년 수주 프로젝트 조회**
- **API**: `GET /api/projects`
- **필터 파라미터**:
  - `order_de`: 2023년 1월 1일부터 2024년 12월 31일까지 (from_date: 20230101, to_date: 20241231)

**2단계: WBS 정보 조회**
- **API**: 각 프로젝트별 `GET /api/projects/{pjt_cd}/wbs`

**3단계: 부서 정보 조회**
- **API**: `GET /api/departments`
- **필터 파라미터**:
  - `dept_dtt_cd`: 부서 구분이 '실'
  - `use_yn`: Y

**4단계: 최초계약 손익 조회**
- **API**: `GET /api/profit-loss/first-contract`
- **필터 파라미터**: 1단계의 pjt_cd 목록

**5단계: 공통코드 조회**
- **API**: `GET /api/common-codes/PO011` (프로젝트 타입)

#### 🔄 데이터 조합 로직

1. 이천이십삼년과 이천이십사년에 수주된 프로젝트 목록 확보
2. WBS와 부서 정보를 통해 사업실 구분
3. 각 프로젝트의 최초계약 손익에서 영업이익율 계산:
   - 영업이익율 = (po_f_biz_prof / po_f_rev_amt) × 100

4. 년도별, 사업실별, 프로젝트 타입별로 그룹핑
5. 각 그룹별 집계:
   - 프로젝트 수
   - 평균 영업이익율
   - 최대 영업이익율
   - 최소 영업이익율
   - 이익율 구간별 분포 (20% 이상, 10~20%, 0~10%, 적자)

6. 그래프 데이터 생성:
   - 라인 차트: 년도별, 사업실별 평균 이익율 추이
   - 박스 플롯: 프로젝트 타입별 이익율 분포
   - 스택 바 차트: 이익율 구간별 프로젝트 수 분포

#### 💡 비즈니스 로직 (자연어)

최초계약이익율을 분석하고 그래프로 시각화하기 위해서는 최근 이 개년간 수주된 프로젝트의 손익 데이터를 분석합니다.

먼저 프로젝트 목록에서 수주일자가 이천이십삼년 일월 일일부터 이천이십사년 십이월 삼십일일 사이인 프로젝트를 조회합니다. 각 프로젝트의 WBS 정보를 통해 부서 코드를 확인하고, 부서 정보와 매칭하여 사업실 구분을 파악합니다. 부서 구분이 '실'인 조직으로 한정하여 사업실 단위로 분석합니다.

각 프로젝트의 최초계약 손익 정보를 조회합니다. 최초 사업이익 필드는 영업이익에 해당하며, 이를 최초 매출액으로 나눈 후 백을 곱하여 영업이익율을 계산합니다.

프로젝트 타입 정보도 함께 수집합니다. 공통코드를 통해 프로젝트 타입 코드값을 의미 있는 명칭으로 변환합니다.

수주 년도는 수주일자의 앞 네 자리를 추출하여 구분합니다. 이천이십삼년과 이천이십사년 두 개 년도로 분류됩니다.

데이터를 다음과 같이 다차원으로 그룹핑하여 집계합니다:
- 년도별 × 사업실별
- 년도별 × 프로젝트 타입별
- 사업실별 × 프로젝트 타입별

각 그룹에 대해 다음 통계값을 계산합니다:
- 프로젝트 개수
- 평균 영업이익율
- 최대 영업이익율
- 최소 영업이익율
- 표준편차

또한 영업이익율을 구간별로 분류하여 분포를 파악합니다:
- 이십 퍼센트 이상: 고수익 프로젝트
- 십 퍼센트 이상 이십 퍼센트 미만: 적정 수익 프로젝트
- 영 퍼센트 이상 십 퍼센트 미만: 저수익 프로젝트
- 영 퍼센트 미만: 적자 프로젝트

각 구간에 속하는 프로젝트 수와 비율을 계산합니다.

그래프는 다음 세 가지 유형으로 생성합니다:

첫째, 라인 차트는 년도별 사업실별 평균 영업이익율 추이를 보여줍니다. X축은 년도, Y축은 평균 영업이익율이며, 각 사업실을 다른 색상의 선으로 표현합니다. 이를 통해 각 사업실의 이익율 변화 추이와 사업실 간 비교가 가능합니다.

둘째, 박스 플롯은 프로젝트 타입별 영업이익율 분포를 시각화합니다. X축은 프로젝트 타입, Y축은 영업이익율입니다. 각 박스는 사분위수를 나타내며, 중앙값, 최대값, 최소값, 이상치를 함께 표시합니다. 프로젝트 타입별로 이익율의 변동성과 중앙 경향을 파악할 수 있습니다.

셋째, 스택 바 차트는 이익율 구간별 프로젝트 수 분포를 보여줍니다. X축은 년도 또는 사업실, Y축은 프로젝트 수이며, 각 막대는 이익율 구간별로 색상을 달리하여 누적 표시합니다. 적자 프로젝트는 붉은색, 저수익은 주황색, 적정 수익은 초록색, 고수익은 파란색으로 구분하여 시각적으로 수익성 분포를 파악할 수 있습니다.

이러한 분석과 그래프를 통해 경영진은 사업실별, 프로젝트 타입별 수익성을 평가하고, 개선이 필요한 영역을 식별하며, 향후 수주 전략을 수립할 수 있습니다.

---

## 🔑 공통 활용 정보

### API 호출 시 주의사항

1. **페이징 처리**:
   - 대부분의 API는 page, pageSize 파라미터 지원
   - 기본 pageSize는 100
   - 전체 데이터 조회 시 반복 호출 필요

2. **필터링 최적화**:
   - 가능한 API 레벨에서 필터링
   - IN 조건은 배열 형태로 전달
   - 날짜 범위는 from_date, to_date 형식

3. **관계 데이터 조회**:
   - 외래키 기준으로 순차 조회
   - 불필요한 JOIN 방지 (API는 필요한 데이터만)
   - 캐싱 가능한 데이터: 공통코드, 부서정보

### 공통코드 참조 가이드

모든 코드값은 다음 API로 조회:

**유형별 코드 목록**:
- `GET /api/common-codes/{ty_cd}`
- 예: `/api/common-codes/PM003` → 프로젝트 상태 코드 전체 목록

**주요 공통코드 ty_cd**:
- PM003: 프로젝트 상태 (영업, 계약, 실행, 완료, 종료, Drop)
- PO002: 영업진행상태 (0~9단계)
- PO011: 프로젝트 타입 (비매출, 비가동, 각종 매출타입)
- CM080: 결재 상태 (상신, 결재중, 확인, 승인, 취소, 반려)
- CM004: 결재 경로 (PC, 모바일)
- PM039: 계정 구분 (매출, 노무비, 재료비, 협력작업비, 경비, 공통비)

### 데이터 연결 패턴

**프로젝트 중심 조회 패턴**:
```
1. GET /api/projects (필터링) → pjt_cd 목록
2. GET /api/projects/{pjt_cd}/wbs → wbs_cd, dept_cd 목록
3. GET /api/departments → 부서 정보 (dept_cd 기준)
4. 계획/실적 데이터 조회 (pjt_cd + wbs_cd 기준)
```

**시계열 데이터 조회 패턴**:
```
1. 년월 범위 설정 (plan_ym, rsl_ym)
2. 해당 범위의 계획/실적 데이터 조회
3. 프로젝트 정보 역조회
4. 시계열 집계 및 분석
```

### LLM 데이터 조합 전략

1. **단계적 조회**:
   - 기준 엔티티 먼저 조회 (프로젝트, 부서 등)
   - 연관 데이터 순차 조회
   - 최종 조합 및 계산

2. **병렬 조회 가능**:
   - 독립적인 참조 데이터 (공통코드, 부서, 직원)
   - 동일 레벨의 계획/실적 데이터

3. **메모리 최적화**:
   - 필요한 필드만 추출
   - 중복 데이터 제거
   - 집계 후 원본 데이터 폐기

---

## 📊 구현 권장사항

### API 호출 순서

각 질문에 대해 다음 순서로 API 호출:

1. **공통코드 조회** (최우선, 캐싱)
2. **기준 데이터 조회** (프로젝트, 부서)
3. **계획/실적 데이터 조회**
4. **데이터 조합 및 계산** (LLM 레벨)
5. **결과 포맷팅 및 반환**

### 성능 최적화

- 공통코드, 부서정보는 세션 단위 캐싱
- 프로젝트 목록은 필터링으로 최소화
- 대량 데이터는 배치 처리 (POST search API 활용)
- 불필요한 필드는 조회하지 않음 (API가 필드 선택 지원 시)

### 에러 처리

- API 호출 실패 시 재시도 로직
- 데이터 누락 시 기본값 처리
- 계산 오류 시 로그 기록 및 사용자 알림
- 공통코드 미존재 시 코드값 그대로 표시

### 그래프 생성 (질문 8)

**라이브러리 선택**:
- 웹 환경: Chart.js, Recharts, D3.js
- 서버 환경: matplotlib (Python), ggplot2 (R)

**데이터 형식**:
- 라인 차트: [{year: 2023, real: '실A', avgRate: 15.2}, ...]
- 박스 플롯: [{type: 'Type1', values: [10, 12, 15, 18, 20]}, ...]
- 스택 바 차트: [{year: 2023, range1: 5, range2: 10, range3: 8, range4: 2}, ...]

---

**작성**: AI 분석 (API 기반)  
**버전**: 1.0  
**최종 수정일**: 2024-11-06  
**참고**: api.yaml, domain.md, coq_answer_from_domain_simple.md

